<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>General Air Fantasy Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    h1, h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin: 20px auto; background: white; }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #003366; color: white; }
    .error { color: red; text-align: center; font-weight: bold; }
    .at-risk { background-color: #ffe6e6; font-weight: bold; color: #cc0000; }
  </style>
</head>
<body>

  <h1>General Air Fantasy Football Dashboard</h1>

  <h2>General Air – Advance Series</h2>
  <div id="advance-error" class="error"></div>
  <table id="advance-table">
    <thead>
      <tr>
        <th>Team</th>
        <th>Manager</th>
        <th>Record</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>General Air – Plus Series</h2>
  <div id="plus-error" class="error"></div>
  <table id="plus-table">
    <thead>
      <tr>
        <th>Team</th>
        <th>Manager</th>
        <th>Record</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadLeague(leagueId, tableId, errorId, highlightBottom3 = false) {
      try {
        const response = await fetch(`/.netlify/functions/espn-proxy?leagueId=${leagueId}`);
        if (!response.ok) throw new Error("Error fetching data");

        const data = await response.json();
        const teams = data.teams;
        const members = data.members;

        // Sort teams by wins descending, then losses ascending
        teams.sort((a, b) => {
          const winDiff = b.record.overallWins - a.record.overallWins;
          return winDiff !== 0 ? winDiff : a.record.overallLosses - b.record.overallLosses;
        });

        const tableBody = document.querySelector(`#${tableId} tbody`);
        tableBody.innerHTML = '';

        teams.forEach((team, index) => {
          const manager = members.find(m => m.id === team.primaryOwner);
          const row = document.createElement('tr');

          if (highlightBottom3 && index >= teams.length - 3) {
            row.classList.add('at-risk');
          }

          row.innerHTML = `
            <td>${team.location} ${team.nickname}</td>
            <td>${manager ? manager.firstName + ' ' + manager.lastName : 'N/A'}</td>
            <td>${team.record.overallWins}-${team.record.overallLosses}</td>
          `;
          tableBody.appendChild(row);
        });
      } catch (err) {
        console.error(err);
        document.getElementById(errorId).textContent = "Error loading data for this league.";
      }
    }

    // Load both leagues
    loadLeague(28619535, 'advance-table', 'advance-error', true); // Advance Series
    loadLeague(1816101066, 'plus-table', 'plus-error'); // Plus Series
  </script>

</body>
</html>
